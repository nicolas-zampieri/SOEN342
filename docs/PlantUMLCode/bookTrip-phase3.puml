@startuml BookTrip-phase3
title Book a Trip Sequence Diagram (with Layover Policy and Unique Trip ID)

actor Client
participant "RailSearchApp (UI)" as UI
participant "BookingSystem" as BS
participant "Trip"
participant "Reservation"
participant "Ticket"
participant "BookingStorage" as DB

Client -> UI: Select connection + Enter traveller info
UI -> BS: bookTrip(connection, travellers)

activate BS
BS -> BS: validateInput(connection, travellers)

alt valid input
  ' Layover policy check
  BS -> BS: evaluateLayoverPolicy(connection)
  
  alt layover acceptable
    BS -> Trip: createTrip(connection)
    Trip --> BS: trip instance

    ' Assign a unique numerical ID to the trip
    BS -> BS: assignUniqueTripId(trip)
    BS -> Trip: setTripId(tripId)

    loop for each traveller
      BS -> Reservation: createReservation(traveller, connection)
      Reservation --> BS: reservation
      BS -> Ticket: createTicket(reservation)
      Ticket --> BS: ticket
      BS -> Trip: add(reservation, ticket)
    end

    BS -> DB: saveTrip(trip)
    DB --> BS: confirmation

    BS --> UI: success(tripId, tickets)
  else layover violates policy
    BS --> UI: error("connection violates layover policy")
  end

else invalid input
  BS --> UI: error("invalid input")
end

UI --> Client: show confirmation or error
deactivate BS
@enduml
