@startuml bookTrip
title Internal Operation â€” bookTrip() Complete Flow

actor User as U
participant "BookingSystem" as BS
participant "BookingStorage" as Storage
participant "Trip" as T
participant "Reservation" as R
participant "Ticket" as TK
participant "ResultRenderer" as Renderer

U -> BS : bookTrip()

== Validation Phase ==
BS -> BS : validate()

alt No itinerary selected
    BS -> Renderer : error("Select an itinerary from results first.")
    return
end

alt No travel date
    BS -> Renderer : error("Pick a travel date.")
    return
end

alt No travellers
    BS -> Renderer : error("Add at least one traveller.")
    return
end

== Trip Creation Phase ==
BS -> BS : tripId = randomAlphaId()
BS -> T ** : new Trip(tripId, dateISO, selectedItinerary, fareClass)

== Reservation & Ticket Generation ==
loop For each traveller
    BS -> BS : reservationId = uuid4()
    BS -> R ** : new Reservation(reservationId, traveller, itineraryKey, fareClass)
    BS -> T : addReservation(reservation)
    
    BS -> BS : ticketNum = randomTicketNumber()
    BS -> TK ** : new Ticket(ticketNum, reservationId)
    BS -> T : addTicket(ticket)
end

== Persistence ==
BS -> Storage : pushTrip(trip)
Storage -> Storage : loadAll()
Storage -> Storage : trips.push(newTrip)
Storage -> Storage : saveAll(trips)

== Success Response ==
BS -> Renderer : info("Trip booked! Trip ID {tripId} with {count} reservation(s).")

== Reset UI State ==
BS -> BS : travellers = []
BS -> BS : renderTravellers()
BS -> BS : clearSelection()
BS -> BS : selectedItinerary = null
BS -> BS : selectedKey = null

@enduml