@startuml classDiagram
title Rail Search â€” Class Diagram
left to right direction
skinparam classAttributeIconSize 0

' ==== Enumerations ====
enum Day {
  Mon
  Tue
  Wed
  Thu
  Fri
  Sat
  Sun
  Daily
}

class Class {
  <<enumeration>>
  first
  second
}

' ==== Value Objects ====
class TimeOfDay {
  +h : int
  +m : int
  +minutes() : int
}

' ==== Domain Entities ====
class Route {
  +route_id : string
  +dep_city : string
  +arr_city : string
  +dep_time : TimeOfDay
  +arr_time : TimeOfDay
  +train_type : string
  +days : Set<Day>
  +price_first : number
  +price_second : number
  +duration (): int
}

class Itinerary {
  +legs : List<Route>
  +transfers : List<int>
  +totalDuration() : int
  +price(cls : Class) : number
}

class Query {
  +dep_city : string?
  +arr_city : string?
  +train_type : string?
  +days : Set<Day>?
  +dep_from : TimeOfDay?
  +dep_to : TimeOfDay?
  +max_price_first : number?
  +max_price_second : number?
}

' ==== Services / Utilities ====
class ItineraryService {
  +filterRoutes(routes : Route[], q : Query) : Route[]
  +findItineraries(routes : Route[], depCity : string, arrCity : string, maxStops : int, minTransfer : int) : Itinerary[]
  +totalDuration(itin : Itinerary) : int
  +price(itin : Itinerary, cls : Class) : number
  +sort(itins : Itinerary[], sortBy : string, cls : Class) : Itinerary[]
}

class DayUtils {
  +normalizeToken(token : string) : Day
  +parseDays(raw : string) : Set<Day>
  +parseInputDays(raw : string) : Set<Day>
}

class TimeUtils {
  +parseTime(value : string) : TimeOfDay
  +minutesBetween(start : TimeOfDay, end : TimeOfDay) : int
  +legDuration(dep : TimeOfDay, arr : TimeOfDay) : int
  +formatHM(minutes : int) : string
}

class HeaderNormalizer {
  +normalize(headers : string[]) : HeaderMap
}

class CSVLoader {
  -parser
  +load(file) : Route[]
}

class ResultRenderer {
  -elements
  -tableBody
  -summary
  +render(itins : Itinerary[], cls : Class)
  +clearResults()
  +updateSummary(info : string)
  +updateMessage(msg : string, isError : bool)
  +updateKPIs(metrics)
  +resetKPIs()
  +updateResultsCount(count : int)
}

class RailSearchApp {
  -routes : Route[]
  -lastResults : Itinerary[]
  -elements
  -loader : CSVLoader
  -renderer : ResultRenderer
  +init()
  +handleFileChange(event)
  +handleReset()
  +buildQuery() : Query
  +handleSearch()
  +handleExport()
}

' ==== Booking Domain (Iteration 2) ====
class Ticket {
  +id : int
  +reservationId : string
}

class Reservation {
  +reservationId : string
  +passenger : Passenger
  +itineraryKey : string
  +fareClass : string
}

class Trip {
  +tripId : string
  +dateISO : string
  +itinerary : Itinerary
  +fareClass : string
  +reservations : List<Reservation>
  +tickets : List<Ticket>
  +createdAt : string
  +addReservation(res : Reservation)
  +addTicket(ticket : Ticket)
}

class Passenger {
  +name : string
  +age : int
  +id : string
}

class BookingStorage {
  +{static} STORAGE_KEY : string
  +{static} loadAll() : Trip[]
  +{static} saveAll(trips : Trip[])
  +{static} pushTrip(trip : Trip)
  +{static} findByLastNameAndId(lastName : string, govId : string) : Trip[]
}

class BookingSystem {
  -renderer : ResultRenderer
  -selectedItinerary : Itinerary
  -selectedKey : string
  -travellers : List<Passenger>
  -dateISO : string
  -fareClass : string
  -inputs
  -buttons
  -viewInputs
  +bind()
  +setSelection(itinerary : Itinerary)
  +clearSelection()
  +addTravellerFromInputs()
  +removeTraveller(idx : int)
  +renderTravellers()
  +validate() : string
  +bookTrip()
  +viewTrips()
  +{static} keyForItinerary(itin : Itinerary) : string
  +{static} humanSummary(itin : Itinerary) : string
  +{static} randomTicketNumber() : int
  +{static} randomAlphaId() : string
  +{static} uuid4() : string
  +{static} renderTripRow(trip : Trip) : string
  +info(msg : string)
  +error(msg : string)
}

' ==== Associations / Dependencies ====
Itinerary --> Route
Route -->TimeOfDay 
Route --> TimeOfDay 
Route --> Day 

ItineraryService --> Route
ItineraryService --> Itinerary
ItineraryService --> Query
ItineraryService --> Class

CSVLoader --> HeaderNormalizer
CSVLoader --> TimeOfDay
CSVLoader --> Day

DayUtils --> Day
TimeUtils --> TimeOfDay

RailSearchApp --> CSVLoader
RailSearchApp --> ResultRenderer
RailSearchApp --> ItineraryService
RailSearchApp --> BookingSystem

' Booking System Relationships
Trip "1" *-- "1..*" Reservation : contains
Trip "1" *-- "1..*" Ticket : contains
Trip "1" --> "1" Itinerary : references
Reservation "1" --> "1" Passenger : for
Reservation "1" --> "1" Class : fareClass
Ticket "1" --> "1" Reservation : documents

BookingSystem --> Trip : creates
BookingSystem --> Reservation : creates
BookingSystem --> Ticket : generates
BookingSystem --> BookingStorage : uses
BookingSystem --> ResultRenderer : uses
BookingSystem --> Itinerary : selects

BookingStorage --> Trip : persists

@enduml
